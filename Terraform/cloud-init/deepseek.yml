#cloud-config

# Lietotāja konfigurācija
users:
  - name: ${ssh_user}
    groups: [sudo, docker]
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${ssh_public_key}

# Drošība
disable_root: true
ssh_pwauth: false

# Pakotnes, kas jāinstalē
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - software-properties-common
  - git

# Runcmd

runcmd:

  # 1. Izveidojam SWAP (2GB), lai CPX21 serveris būtu stabils
  - fallocate -l 2G /swapfile
  - chmod 600 /swapfile
  - mkswap /swapfile
  - swapon /swapfile
  - echo '/swapfile none swap sw 0 0' >> /etc/fstab
  
  # Docker instalācija no oficiālā Docker repo
  - |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
    apt-get update
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    systemctl enable docker
    systemctl start docker

  # Docker daemon TCP konfigurācija
  - |
    sed -i 's|ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock|ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock|' /lib/systemd/system/docker.service
    mkdir -p /etc/docker
    cat << 'EOF' > /etc/docker/daemon.json
    {
      "hosts": ["tcp://127.0.0.1:2375", "unix:///var/run/docker.sock"]
    }
    EOF
    systemctl daemon-reload
    systemctl restart docker

  # Pievieno lietotāju docker grupai (ja vēl nav)
  - usermod -aG docker ${ssh_user}
  # Izveido .ssh mapes, ja vēl nav
  - mkdir -p /home/${ssh_user}/.ssh
  - echo "${ssh_public_key}" >> /home/${ssh_user}/.ssh/authorized_keys
  - chown -R ${ssh_user}:${ssh_user} /home/${ssh_user}/.ssh
  - chmod 700 /home/${ssh_user}/.ssh
  - chmod 600 /home/${ssh_user}/.ssh/authorized_keys

  # Ģenerē GitHub Actions SSH key (ED25519, bez paroles)
  - sudo -u ${ssh_user} ssh-keygen -t ed25519 -f /home/${ssh_user}/.ssh/github_actions -C "github-actions@kalendars" -N ""

  # Pievieno GitHub Actions publisko key pie authorized_keys
  - cat /home/${ssh_user}/.ssh/github_actions.pub >> /home/${ssh_user}/.ssh/authorized_keys
  - chmod 600 /home/${ssh_user}/.ssh/authorized_keys

  # Konfigurējam Ollama, lai tā būtu pieejama Docker konteineriem
  - |
    mkdir -p /etc/systemd/system/ollama.service.d
    cat <<EOF > /etc/systemd/system/ollama.service.d/override.conf
    [Service]
    Environment="OLLAMA_HOST=0.0.0.0"
    Environment="OLLAMA_ORIGINS=*"
    EOF
    systemctl daemon-reload

  # 1. Instalē Ollama
  - curl -fsSL https://ollama.com/install.sh | sh

  # 2. Konfigurējam Ollama (Host un Origins)
  - |
    mkdir -p /etc/systemd/system/ollama.service.d
    cat <<EOF > /etc/systemd/system/ollama.service.d/override.conf
    [Service]
    Environment="OLLAMA_HOST=0.0.0.0"
    Environment="OLLAMA_ORIGINS=*"
    EOF
    systemctl daemon-reload
    systemctl restart ollama

  # 3. Pagaidām API gatavību
  - |
    until curl -s http://localhost:11434/api/tags > /dev/null; do
      sleep 3
    done

  # 4. Velkam bāzes modeli
  - /usr/local/bin/ollama pull deepseek-coder:6.7b

  # 5. Izveidojam Modelfile (izmantojam /tmp, lai nav permisiju problēmu)
  - |
    cat <<EOF > /tmp/Modelfile
    FROM deepseek-coder:6.7b
    PARAMETER num_ctx 4096
    PARAMETER num_thread 4
    EOF

  # 6. Izveidojam pielāgoto modeli
  - /usr/local/bin/ollama create deepseek-custom -f /tmp/Modelfile
  
  # 7. Tīrīšana un finiša darbi
  - rm /tmp/Modelfile
  - systemctl restart ollama
  - systemctl reload ssh