name: Deploy DeepSeek

on:
  push:
    paths:
      - ".github/workflows/deploy.yml"
      - "**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TEST_SERVER_SSH_PRIVATE_KEY }}

      - name: Start SSH tunnel
        run: |
          # Izmantojam ExitOnForwardFailure drošībai
          ssh -o StrictHostKeyChecking=no -o ExitOnForwardFailure=yes -fNL 2375:localhost:2375 ${{ secrets.TEST_SERVER_USER }}@${{ secrets.TEST_SERVER_IP }}
          sleep 5

      - name: Run Docker Compose
        env:
          DOCKER_HOST: tcp://localhost:2375
          TEST_TUNNEL_TOKEN: ${{ secrets.TEST_TUNNEL_TOKEN }}
        run: |
          # Pārliecinies, ka docker-compose.yml atrodas repozitorija saknē
          docker compose up -d --build --remove-orphans
          docker image prune -f
